<?php

namespace MandarinMedien\MMCmfAdminBundle\Controller;

use MandarinMedien\MMCmfAdminBundle\Response\JsonFormResponse;
use Symfony\Bundle\FrameworkBundle\Controller\Controller;
use Symfony\Component\Form\Form;
use Symfony\Component\HttpFoundation\Response;

class CmfAdminBaseController extends Controller
{

    /**
     * render function
     * sets the template to extend from
     *
     * {@inheritdoc}
     */
    public function render($view, array $parameters = array(), Response $response = null)
    {
        if($this->get('request')->isXmlHttpRequest())
        {
            $parameters['extends_from'] = 'MMCmfAdminBundle:Admin:admin.xhr.html.twig';
        }  else {
            $parameters['extends_from'] = 'MMCmfAdminBundle:Admin:admin.html.twig';
        }

        return parent::render($view, $parameters, $response); // TODO: Change the autogenerated stub
    }


    /**
     * default response for Form Actions
     * returns either JsonFormResponse on XHR Request or RedirectResponse
     *
     * @param Form $form the handled form
     * @return JsonFormResponse|\Symfony\Component\HttpFoundation\RedirectResponse
     */
    public function formResponse(Form $form)
    {
        $request = $this->get('request');

        if($request->isXmlHttpRequest())
        {
            return new JsonFormResponse($form);
        } else {

            if($form->has('save_and_add') && $form->get('save_and_add')->isClicked()) {
                $redirect = $form->get('save_and_add')->getConfig()->getOption('attr')['data-target'];
            }

            elseif($form->has('save_and_back') &&  $form->get('save_and_back')->isClicked()) {
                $redirect = $form->get('save_and_back')->getConfig()->getOption('attr')['data-target'];
            }

            else {
                $redirect = $request->headers->get('referer');
            }

            return $this->redirect($redirect);
        }
    }
}